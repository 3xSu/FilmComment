<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fc.mapper.api.PostPublicMapper">

    <!-- 根据ID查询帖子（包含已删除的帖子，用于管理员） -->
    <select id="getByPostId" resultType="com.fc.entity.Post">
        SELECT * FROM post WHERE post_id = #{postId}
    </select>

    <!-- 根据ID查询未删除的帖子 -->
    <select id="getByPostIdNotDeleted" resultType="com.fc.entity.Post">
        SELECT * FROM post WHERE post_id = #{postId} AND is_deleted = 0
    </select>

    <!-- 游标分页查询帖子（按创建时间倒序） -->
    <select id="pageQueryPostsByCursor" resultType="com.fc.vo.post.PostSearchVO">
        SELECT
        p.post_id,
        p.user_id,
        p.movie_id,
        p.title,
        p.content,
        p.post_type,
        p.content_form,
        p.video_url,
        p.view_count,
        p.like_count,
        p.collect_count,
        p.create_time,
        p.update_time
        FROM post p
        WHERE p.is_deleted = 0
        <if test="cursor != null">
            AND p.create_time &lt; #{cursor}
        </if>
        <if test="movieId != null">
            AND p.movie_id = #{movieId}
        </if>
        <if test="postType != null">
            AND p.post_type = #{postType}
        </if>
        <if test="contentForm != null">
            AND p.content_form = #{contentForm}
        </if>
        <if test="spoilerType != null">
            <choose>
                <!-- 无剧透区：post_type=1或3 -->
                <when test="spoilerType == 1">
                    AND p.post_type IN (1, 3)
                </when>
                <!-- 深度讨论区：post_type=2或4 -->
                <when test="spoilerType == 2">
                    AND p.post_type IN (2, 4)
                </when>
            </choose>
        </if>
        ORDER BY p.create_time DESC
        <if test="size != null">
            LIMIT #{size}
        </if>
    </select>

    <!-- 统计帖子数量（用于分页） -->
    <select id="countPosts" resultType="long">
        SELECT COUNT(*)
        FROM post p
        WHERE p.is_deleted = 0
        <if test="movieId != null">
            AND p.movie_id = #{movieId}
        </if>
        <if test="postType != null">
            AND p.post_type = #{postType}
        </if>
        <if test="contentForm != null">
            AND p.content_form = #{contentForm}
        </if>
        <if test="spoilerType != null">
            <choose>
                <when test="spoilerType == 1">
                    AND p.post_type IN (1, 3)
                </when>
                <when test="spoilerType == 2">
                    AND p.post_type IN (2, 4)
                </when>
            </choose>
        </if>
    </select>

    <!-- 根据用户ID查询帖子列表 -->
    <select id="pageQueryPostsByUserId" resultType="com.fc.vo.post.PostSearchVO">
        SELECT
        p.post_id,
        p.user_id,
        p.title,
        p.content,
        p.create_time,
        p.view_count,
        p.like_count,
        p.collect_count
        FROM post p
        WHERE
        p.user_id = #{userId}
        AND p.is_deleted = 0
        <if test="cursor != null">
            AND p.create_time &lt; #{cursor}
        </if>
        ORDER BY p.create_time DESC
        limit #{size}
    </select>


</mapper>